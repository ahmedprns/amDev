<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر الصور</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            margin: 20px;
        }
        #canvas-container {
            border: 1px solid #ddd;
            margin-top: 20px;
            position: relative;
            overflow: auto; /* Enable scrolling */
            max-width: 100%;
            max-height: 80vh; /* Limit height for scrolling */
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button {
            padding: 10px;
            cursor: pointer;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        #crop-rectangle {
            border: 2px dashed red;
            position: absolute;
            display: none;
        }
        .crop-buttons {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h2>محرر الصور</h2>

<!-- Controls for editing -->
<div class="toolbar">
    <div class="controls">
        <input type="file" id="file-input" />
        <button onclick="resetImage()">إعادة تعيين</button>
        <button onclick="saveImage()">حفظ الصورة</button>
    </div>
</div>

<div class="controls">
    <div class="control-group">
        <label for="brightness">السطوع:</label>
        <input type="range" id="brightness" min="-100" max="100" value="0" onchange="adjustImage()" />
        <span id="brightness-value">0</span>
    </div>

    <div class="control-group">
        <label for="contrast">التباين:</label>
        <input type="range" id="contrast" min="-100" max="100" value="0" onchange="adjustImage()" />
        <span id="contrast-value">0</span>
    </div>

    <div class="control-group">
        <label for="resize">الحجم:</label>
        <input type="range" id="resize" min="10" max="300" value="100" onchange="adjustImageSize()" />
        <span id="resize-value">100%</span>
    </div>

    

    <div class="control-group">
        <label for="red">الأحمر:</label>
        <input type="range" id="red" min="-100" max="100" value="0" onchange="adjustImage()" />
        <span id="red-value">0</span>
    </div>

    <div class="control-group">
        <label for="green">الأخضر:</label>
        <input type="range" id="green" min="-100" max="100" value="0" onchange="adjustImage()" />
        <span id="green-value">0</span>
    </div>

    <div class="control-group">
        <label for="blue">الأزرق:</label>
        <input type="range" id="blue" min="-100" max="100" value="0" onchange="adjustImage()" />
        <span id="blue-value">0</span>
    </div>


    <button onclick="flipImage('horizontal')">قلب أفقي</button>
    <button onclick="flipImage('vertical')">قلب رأسي</button>
    <button onclick="rotateImage('left')">تدوير لليسار</button>
    <button onclick="rotateImage('right')">تدوير لليمين</button>
</div>

<!-- Canvas Container -->
<div id="canvas-container">
    <canvas id="canvas" width="500" height="400"></canvas>
    <div id="crop-rectangle"></div>
</div>

<!-- Crop action buttons -->
<div class="crop-buttons">
    <button onclick="applyCrop()">موافق</button>
    <button onclick="cancelCrop()">إلغاء</button>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let originalImage = null;
    let img = new Image();
    let currentWidth, currentHeight;
    let isFlippedHorizontally = false;
    let isFlippedVertically = false;
    let cropping = false;
    let cropStartX, cropStartY, cropEndX, cropEndY;
    const cropRectangle = document.getElementById('crop-rectangle');
    const cropButtons = document.querySelector('.crop-buttons');
    let rotationAngle = 0; // Track the rotation angle
    let resizeValue = 1; // Store the resize factor

    // Load image from input and reset values
    document.getElementById('file-input').addEventListener('change', function (e) {
        const reader = new FileReader();
        reader.onload = function (event) {
            img.onload = function () {
                originalImage = img;
                currentWidth = img.width;
                currentHeight = img.height;
                resetImage();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    // Draw image on canvas
    function drawImage() {
        canvas.width = currentWidth;
        canvas.height = currentHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();

        // Apply rotation
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(rotationAngle * Math.PI / 180);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);

        // Apply flip transformations
        ctx.translate(isFlippedHorizontally ? canvas.width : 0, isFlippedVertically ? canvas.height : 0);
        ctx.scale(isFlippedHorizontally ? -1 : 1, isFlippedVertically ? -1 : 1);
        
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        ctx.restore();
        adjustImage();
    }

    // Adjust Brightness and Contrast
    function adjustImage() {
        const brightness = parseInt(document.getElementById('brightness').value);
        const contrast = parseInt(document.getElementById('contrast').value);
        const redAdjustment = parseInt(document.getElementById('red').value);
        const greenAdjustment = parseInt(document.getElementById('green').value);
        const blueAdjustment = parseInt(document.getElementById('blue').value);

        document.getElementById('brightness-value').textContent = brightness;
        document.getElementById('contrast-value').textContent = contrast;
        document.getElementById('red-value').textContent = redAdjustment;
        document.getElementById('green-value').textContent = greenAdjustment;
        document.getElementById('blue-value').textContent = blueAdjustment;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.filter = `brightness(${brightness + 100}%) contrast(${contrast + 100}%)`;
        
        // Apply color adjustments
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            data[i] += redAdjustment;     // Red
            data[i + 1] += greenAdjustment; // Green
            data[i + 2] += blueAdjustment;  // Blue
        }

        ctx.putImageData(imageData, 0, 0);


        // Apply rotation
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(rotationAngle * Math.PI / 180);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);

        // Apply flip transformations
        ctx.translate(isFlippedHorizontally ? canvas.width : 0, isFlippedVertically ? canvas.height : 0);
        ctx.scale(isFlippedHorizontally ? -1 : 1, isFlippedVertically ? -1 : 1);
        
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        ctx.restore();
    }

    // Resize Image
    function adjustImageSize() {
        resizeValue = parseInt(document.getElementById('resize').value) / 100;
        currentWidth = originalImage.width * resizeValue;
        currentHeight = originalImage.height * resizeValue;
        document.getElementById('resize-value').textContent = `${resizeValue * 100}%`;
        drawImage();
    }

    // Flip Image horizontally or vertically
    function flipImage(direction) {
        if (direction === 'horizontal') {
            isFlippedHorizontally = !isFlippedHorizontally;
        } else if (direction === 'vertical') {
            isFlippedVertically = !isFlippedVertically;
        }
        drawImage();
    }

    // Rotate Image
    function rotateImage(direction) {
        rotationAngle += (direction === 'left' ? -90 : 90);
        drawImage();
    }

    // Start cropping mode
    function startCrop() {
        cropping = true;
        cropButtons.style.display = 'none'; // Hide crop buttons initially
        cropRectangle.style.display = 'none'; // Hide the crop rectangle
        canvas.addEventListener('mousedown', setCropStart);
    }

    // Set the start point for cropping
    function setCropStart(event) {
        const rect = canvas.getBoundingClientRect();
        cropStartX = (event.clientX - rect.left) / resizeValue;
        cropStartY = (event.clientY - rect.top) / resizeValue;

        canvas.removeEventListener('mousedown', setCropStart);
        canvas.addEventListener('mouseup', setCropEnd);
    }

    // Set the end point for cropping
    function setCropEnd(event) {
        const rect = canvas.getBoundingClientRect();
        cropEndX = (event.clientX - rect.left) / resizeValue;
        cropEndY = (event.clientY - rect.top) / resizeValue;

        // Calculate crop rectangle coordinates
        const x = Math.min(cropStartX, cropEndX);
        const y = Math.min(cropStartY, cropEndY);
        const width = Math.abs(cropEndX - cropStartX);
        const height = Math.abs(cropEndY - cropStartY);
        
        // Update crop rectangle style
        cropRectangle.style.left = `${(x * resizeValue)}px`;
        cropRectangle.style.top = `${(y * resizeValue)}px`;
        cropRectangle.style.width = `${(width * resizeValue)}px`;
        cropRectangle.style.height = `${(height * resizeValue)}px`;
        cropRectangle.style.display = 'block'; // Show the crop rectangle
        cropButtons.style.display = 'block'; // Show crop buttons

        canvas.removeEventListener('mouseup', setCropEnd);
    }

    // Apply cropping
    function applyCrop() {
        const x = Math.min(cropStartX, cropEndX);
        const y = Math.min(cropStartY, cropEndY);
        const width = Math.abs(cropEndX - cropStartX);
        const height = Math.abs(cropEndY - cropStartY);

        // Crop the image
        const imageData = ctx.getImageData(x, y, width, height);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(imageData, 0, 0);
        
        // Reset cropping variables
        cropping = false;
        cropRectangle.style.display = 'none'; // Hide crop rectangle
        cropButtons.style.display = 'none'; // Hide crop buttons
    }

    // Cancel cropping
    function cancelCrop() {
        cropRectangle.style.display = 'none'; // Hide crop rectangle
        cropButtons.style.display = 'none'; // Hide crop buttons
        drawImage(); // Redraw original image
    }

    // Reset Image
    function resetImage() {
        document.getElementById('brightness').value = 0;
        document.getElementById('contrast').value = 0;
        document.getElementById('resize').value = 100;
        document.getElementById('brightness-value').textContent = '0';
        document.getElementById('contrast-value').textContent = '0';
        document.getElementById('resize-value').textContent = '100%';
        rotationAngle = 0; // Reset rotation

        currentWidth = originalImage ? originalImage.width : 500;
        currentHeight = originalImage ? originalImage.height : 400;
        isFlippedHorizontally = false;
        isFlippedVertically = false;
        cropping = false;
        cropRectangle.style.display = 'none';
        cropButtons.style.display = 'none';

        drawImage();
    }

    // Save the edited image
    function saveImage() {
        const dataURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'edited_image.png';
        link.click();
    }
</script>

</body>
</html>
